(()=>{"use strict";class e{constructor(e=null){e&&(this.mountedElement=e)}pushComponent(e=null){let t=this.render();(e||this.mountedElement).append(t)}mountComponent(e=null){let t=this.render(),n=e||this.mountedElement;n.innerText=null,n.append(t)}render(){let e=document.createElement("div");return e.innerText="Base Component",e}}class t extends e{constructor(e,t,n={type:null}){var s,i;super(),i=["btn","btn-outline-success"],(s="_classNames")in this?Object.defineProperty(this,s,{value:i,enumerable:!0,configurable:!0,writable:!0}):this[s]=i,this._text=e,this._cb=t,this._type=n.type,this.onBtnClick=this.onBtnClick.bind(this)}setClasses(...e){e.length>0&&(this._classNames=e)}onBtnClick(){const e=this._cb;if("function"==typeof e)return e();console.log("clicked")}render(){let e=this._getElement();return e.addEventListener("click",(()=>{this.onBtnClick()})),e}_getElement(){let e=document.createElement("button");return e.classList.add(...this._classNames),e.innerText=this._text,this._type&&(e.type=this._type),e}}class n extends e{constructor(e,t){var n;super(),(n="counter")in this?Object.defineProperty(this,n,{value:1,enumerable:!0,configurable:!0,writable:!0}):this[n]=1,this._counter=e,this._cb=t}onBtnClick(e){const t=this._cb;if("increase"===e?this._counter++:this._counter--,"function"==typeof t)return t(e);console.info(`COUNTER: ${e} clicked!`)}render(){let e=document.createElement("div"),n=document.createElement("span"),s=new t("+",this.onBtnClick.bind(this,"increase")),i=new t("-",this.onBtnClick.bind(this,"decrease"));return n.classList.add("mx-2"),n.innerText=this._counter,s.setClasses("btn","btn-outline-secondary","btn-counter","btn-sm","d-flex"),i.setClasses("btn","btn-outline-secondary","btn-counter","btn-sm","d-flex"),e.classList.add("d-flex","mb-4"),s.pushComponent(e),e.insertAdjacentElement("beforeend",n),i.pushComponent(e),e}}class s extends e{constructor(e,t){var n;super(),(n="count")in this?Object.defineProperty(this,n,{value:1,enumerable:!0,configurable:!0,writable:!0}):this[n]=1,this.id=e.id,this.goods=e,this._cart=t}removeItem(){this._cart.remove(this.id)}increment(){let e=++this.count;return e>=100?alert("Вы достигли максимального значения!"):e}decrement(){return this.count<2?this.count:--this.count}render(){let e=this.goods,s=document.createElement("div"),i=new t("Удалить",this.removeItem.bind(this)),r=new n(this.count,(e=>{"increase"===e?this.increment():this.decrement(),this._cart.mountComponent()}));s.classList.add("card","mb-2","p-0"),s.innerHTML=`\n                <div class="row g-0">\n                    <div class="col-3">\n                        <img style="width: 100%;" src="${e.image}"  alt="${e.name}">\n                    </div>\n                    <div class="col-8">\n                        <div class="card-body">\n                            <h5 class="card-title">${e.name}</h5>\n                            <p class="card-text">${e.price}₽</p>\n                        </div>\n                    </div>\n                </div>\n        `;let o=s.querySelector(".card-body");return o&&(r.pushComponent(o),i.pushComponent(o)),s}}class i extends Map{set(e,t){t instanceof s&&super.set(e,t)}}class r extends e{constructor(e){super(e),this.items=new i,this._createWrapper(),this._initButtons()}add(e){let t=this.items.get(e.id);return t?t.increment():(t=new s(e,this),this.items.set(t.id,t)),this.mountComponent(),alert("Товар добавлен в корзину!"),!0}remove(e){this.items.has(e)&&(this.items.delete(e),this.mountComponent())}increment(e){let t=this.items.get(e);t&&t.increment()}decrement(e){let t=this.items.get(e);if(!t)return!1;0===t.decrement()&&this.remove(e)}clearCart(){this.items.clear(),this.mountComponent()}_calculateSummary(){let e=this.items,t=0;return e.forEach((e=>{t+=e.goods.price*e.count})),t}_initButtons(){let e=document.querySelector("#cart-buttons"),n=new t("Очистить",this.clearCart.bind(this));e&&n.mountComponent(e)}_initSummary(){let e=this._calculateSummary(),t=document.querySelector("#cart-summary");t&&(t.innerText=e+"₽")}_createWrapper(){let e=document.createElement("div");return e.classList.add("row"),e}render(){let e=this._createWrapper();return this.items.forEach((t=>{t.pushComponent(e)})),this._initSummary(),e}}function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class a extends e{constructor({label:e,id:t,name:n,type:s,required:i},r=null){super(),o(this,"_inputObject",null),o(this,"error",""),o(this,"value",""),this._label=e,this._id=t,this._name=n,this._type=s,this._required=i,this._validate=r,this._onChange=this._onChange.bind(this)}validate(){let e=this._inputObject;return e.isRequired()&&""===e.value.trim()?(this.showError("Поле обязательно к заполненеию"),!1):this._validate?this._validate(this.value,this):void 0}showError(e){alert(e)}render(){let e=document.createElement("div");e.classList.add("mb-3");let t=`<label for="${this._id}" class="form-label">${this._label}</label>`;e.insertAdjacentHTML("afterbegin",t);let n=this._inputObject;return n||(n=new Input({type:this._type,id:this._id,name:this._name,required:this._required},this._onChange)),n.pushComponent(e),this._inputObject=n,e}_onChange(e){this.value=e}}class c extends e{constructor(){var e,t;super(),t=[],(e="_formFields")in this?Object.defineProperty(this,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):this[e]=t}validate(){let e=[];return this._formFields.forEach((t=>{e.push(t.validate())})),e}addField(e){e instanceof a&&this._formFields.push(e)}render(){let e=this._createFormElement();this._formFields.forEach((t=>{t.pushComponent(e)}));let n=new t("Отправить",(()=>{}),{type:"submit"});return n.setClasses("btn","btn-primary"),n.pushComponent(e),e}_createFormElement(){let e=document.createElement("form");return e.method="POST",e.action="/feedback",e.classList.add("col-5","m-auto"),e.addEventListener("submit",(t=>this._setEventListener(t,e))),e}_setEventListener(e,t){e.preventDefault(),this.validate()}}class l{constructor({id:e,name:t,price:n,image:s}){this.id=e,this.name=t,this.price=n,this.image=s}}class d extends e{constructor(e,t){super(),this.goods=new l(e),this.cartInstance=t,this.addToCart=this.addToCart.bind(this)}addToCart(){this.cartInstance.add(this.goods)}createTitle(){let e=this.goods,t=document.createElement("h5");return t.classList.add("card-title","mb-3"),t.innerText=e.name,t}createPrice(){let e=document.createElement("p");return e.innerText=this.goods.price+"₽",e}createCardBody(){let e=document.createElement("div"),n=this.createTitle(),s=this.createPrice(),i=new t("Добавить в корзину",this.addToCart);return e.classList.add("card-body"),e.append(n),e.append(s),i.pushComponent(e),e}render(){let e=this.goods,t=document.createElement("div"),n=document.createElement("div"),s=this.createCardBody();return n.classList.add("col"),t.id="goods-"+e.id,t.classList.add("card"),t.insertAdjacentHTML("afterbegin",`<img src="${e.image}" alt="${e.name}" class="card-img-top">`),t.append(s),n.insertAdjacentElement("afterbegin",t),n}}function h(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class u extends e{constructor(e,t){super(e),h(this,"goods",[]),h(this,"isEndOfList",!1),h(this,"offset",0),this._getCart=this._getCart.bind(this),this._checkScroll=this._checkScroll.bind(this),this.cart=t,this.mountComponent(),this._checkScroll(),this._scrollEventListener()}_checkScroll(){let e=this._getScrollCheck();null!==e&&e.getBoundingClientRect().top<=window.innerHeight&&this._initList()}_scrollEventListener(){document.addEventListener("scroll",this._checkScroll)}_initList(){return!this.isEndOfList&&(this._fetchGoods(++this.offset).then((e=>{this.goods=[...this.goods,...e.map((e=>new d(e,this._getCart())))],this.mountComponent()})).catch((e=>{this.isEndOfList=!0,console.warn("Something went wrong, when list tried init",e)})),!0)}_fetchGoods(e=1){return fetch(`/database/data${e}.json`).then((e=>e.json())).then((e=>e.data))}_getCart(){return this.cart}_getScrollCheck(){return document.querySelector(".scrollCheck")||null}_createScrollCheck(){let e=document.createElement("div");return e.classList.add("scrollCheck"),e}_createGoodsList(){let e=document.createElement("div");return e.classList.add("row","row-cols-1","row-cols-sm-2","row-cols-md-3","row-cols-lg-4","g-3","goodsList"),e}render(){let e=this.goods,t=this._createGoodsList();for(let n of e)n.pushComponent(t);let n=this._createScrollCheck();return t.insertAdjacentElement("beforeend",n),t}}new class{constructor(){this.render()}runCatalog(){let e=document.querySelector("#app"),t=document.querySelector("#cart-list"),n=new r(t);new u(e,n)}runForm(){let e=document.querySelector("#form"),t=new c;t.addField(new a({label:"Имя",id:"name",type:"text",name:"name",required:!0},((e,t)=>!!/^[A-zА-я]+$/g.test(e)||(t.showError("Имя может содержать только буквы"),!1)))),t.addField(new a({label:"E-Mail",id:"email",type:"text",name:"email",required:!0},((e,t)=>!!/^([\w-(\.){1}]{1,64})@([\w-]+)(\.[\w-]+){1,4}\w{2,10}$/gi.test(e)||(t.showError("Введите корректный E-mail"),!1)))),t.addField(new a({label:"Номер телефона",id:"phone",type:"text",name:"phone",required:!0},((e,t)=>!!/^((8|\+7)[\- ]?)(\(?\d{3}\)?[\- ]?)?[\d\- ]{7,10}$/g.test(e)||(t.showError("Введите корректный номер телефона"),!1)))),t.mountComponent(e)}render(){let e=location.pathname.split("/").filter((e=>e));return e[0]&&"form"===e[0]?this.runForm():this.runCatalog()}}})();